def gs    // define a variable for the external groovy script (gs.groovy)

pipeline{
    agent any
    stages{
        stage("load-script"){
            steps{
                script{
                    gs = load "gs.groovy"
                }
            }
        }
        /* 
        stage("build-vote-image"){
            steps{
                script{
                    gs.build('hamdiz0/va-vote','2.0','docker-repo','./vote')    // calling the build function from the external script
                }
            }
        }
        stage("build-result-image"){
            steps{
                script{
                    gs.build('hamdiz0/va-result','2.0','docker-repo','./result')
                }
            }
        }
        stage("build-worker-image"){
            steps{
                script{
                    gs.build('hamdiz0/va-worker','2.0','docker-repo','./worker')
                }
            }
        }
        */
        stage("deploy app"){
            steps{
                sshagent(credentials:['local-k8s']){
                    sh 'ssh -o StrictHostKeyChecking=no vagrant@192.168.1.22 -a'
                    sh 'rm -rf git'
                    sh 'mkdir git ; cd git'
                    sh 'git clone https://github.com/hamdiz0/vote-app.git'
                    sh 'cd vote-app/k8s-specifications'
                    sh 'sudo sh k8s-cluster-run.sh'
                }
            }
        }
    }
}
